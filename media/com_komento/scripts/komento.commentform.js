Komento.module("komento.commentform",function(a){var b=this,c=Komento.require(),d=[];d.push("komento.common"),d.push("komento.upload"),Komento.options.config.enable_bbcode==1&&(d.push("markitup"),d.push("komento.bbcode")),Komento.options.config.show_location==1&&d.push("location"),c.script.apply(c,d).image(Komento.options.spinner).done(function(){Komento.Controller("CommentForm",{defaults:{"{addCommentButton}":".addCommentButton","{formArea}":".formArea","{commentInput}":"#commentInput","{markItUpButtons}":".markItUpButton a","{submitButton}":".submitButton","{parentId}":'input[name="parent"]',"{usernameInput}":"#register-username","{nameInput}":"#register-name","{emailInput}":"#register-email","{websiteInput}":"#register-website","{registerCheckbox}":"#register-checkbox","{tncCheckbox}":".tncCheckbox","{tncRead}":".tncRead","{subscribeForm}":".subscribeForm","{subscribeCheckbox}":".subscribeCheckbox","{unsubscribeButton}":".unsubscribeButton","{locationForm}":".locationForm","{formAlert}":".formAlert","{recaptchaChallenge}":"#recaptcha_challenge_field","{recaptchaResponse}":"#recaptcha_response_field","{captchaImage}":"#captcha-image","{captchaResponse}":"#captcha-response","{recaptchaResponse}":"#recaptcha_response_field","{captchaId}":"#captcha-id","{captchaReload}":".kmt-captcha-reload","{locationInput}":".locationInput","{locationLatitude}":".locationLatitude","{locationLongitude}":".locationLongitude","{parentLink}":".parentLink","{parentContainer}":".parentContainer","{cancelStaticReplyButton}":".cancelStaticReply","{commentLength}":".commentLength","{commentLengthCount}":".commentLengthCount","{uploaderWrap}":".uploaderWrap"}},function(b){return{init:function(){b.parentid=0,b.commentInput().val(""),Komento.options.config.enable_bbcode==1&&b.commentInput().markItUp(a.getBBcodeSettings()),Komento.options.config.show_location==1&&b.locationForm().exists()&&b.locationForm().implement("Komento.Controller.Location.Form.Simple"),Komento.options.config.upload_enable==1&&Komento.options.acl.upload_attachment==1&&b.uploaderWrap().exists()&&(Komento.options.element.commentupload=new Komento.Controller.UploadForm(a(".uploaderWrap")),Komento.options.element.commentupload.kmt=Komento.options.element)},"{commentInput} textChange":function(a){b.commentLengthCheck(),b.experimentalValidateComment()},"{commentInput} keyup":function(a){b.commentLengthCheck()},"[{nameInput}, {emailInput}, {websiteInput}, {commentInput}] keyup":function(){b.experimentalValidateComment()},"[{subscribeCheckbox}, {tncCheckbox}] click":function(){b.experimentalValidateComment()},"{tncRead} click":function(){Komento.require().view("dialogs/comment.tnc").done(function(){a.dialog({title:a.language("COM_KOMENTO_FORM_TNC"),customClass:"kmt-dialog",width:500,showOverlay:!1,content:Komento.View("dialogs/comment.tnc")})})},"{submitButton} click":function(a){a.checkClick()&&a.html('<img src="'+Komento.options.spinner+'" />'),b.validateComment()},"{unsubscribeButton} click":function(a){a.checkClick()&&(a.html('<img src="'+Komento.options.spinner+'" />'),b.unsubscribe())},"{captchaReload} click":function(){b.reloadCaptcha()},"{parentLink} mouseover":function(){b.parentContainer().show()},"{parentLink} mouseout":function(){b.parentContainer().hide()},"{cancelStaticReplyButton} click":function(){b.cancelStaticReply()},"{addCommentButton} click":function(){b.loadForm()},loadForm:function(){Komento.options.config.form_toggle_button==1&&(b.addCommentButton().hide(),b.formArea().show())},hideForm:function(){Komento.options.config.form_toggle_button==1&&(b.addCommentButton().show(),b.formArea().hide())},commentLengthCheck:function(){Komento.options.config.antispam_max_length_enable==1&&b.commentInput().val().length>Komento.options.config.antispam_max_length&&b.commentInput().val(b.commentInput().val().slice(0,Komento.options.config.antispam_max_length)),b.commentLengthCount().text(b.commentInput().val().length)},validateComment:function(){b.clearNotification();if(Komento.options.konfig.enable_js_form_validation==0){b.postComment();return}var c=a.trim(b.nameInput().val()),d=a.trim(b.emailInput().val()),e=a.trim(b.websiteInput().val()),f=a.trim(b.commentInput().val()),g=a.trim(b.captchaResponse().val()),h=a.trim(b.recaptchaResponse().val()),i=[];f.length==0?(b.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_COMMENT_REQUIRED")),i.push("1")):Komento.options.config.antispam_min_length_enable==1&&Komento.options.config.antispam_min_length>0&&f.length<Komento.options.config.antispam_min_length&&(b.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_COMMENT_TOO_SHORT")),i.push("1"));if(b.captchaResponse().exists()&&g.length==0||b.recaptchaResponse().exists()&&h.length==0)b.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_CAPTCHA_REQUIRED")),i.push("1");c.length==0&&(Komento.options.config.show_name==2&&Komento.options.config.require_name==2||Komento.options.guest==1&&Komento.options.config.show_name>0&&Komento.options.config.require_name==1)?(b.nameInput().siblings("span").length==0?b.nameInput().after('<span class="help-inline">'+a.language("COM_KOMENTO_FORM_NOTIFICATION_NAME_REQUIRED")+"</span>"):b.nameInput().siblings("span").show(),b.nameInput().parents("li").addClass("error"),i.push("1")):(b.nameInput().siblings("span").hide(),b.nameInput().parents("li").removeClass("error")),b.emailInput().siblings("span").remove(),d.length==0&&(Komento.options.config.show_email==2&&(Komento.options.config.require_email==2||b.subscribeCheckbox().prop("checked"))||Komento.options.guest==1&&Komento.options.config.show_email>0&&(Komento.options.config.require_email==1||b.subscribeCheckbox().prop("checked")))?(b.emailInput().after('<span class="help-inline">'+a.language("COM_KOMENTO_FORM_NOTIFICATION_EMAIL_REQUIRED")+"</span>"),b.emailInput().parents("li").addClass("error"),i.push("1")):d.length>0&&!b.validateEmail(d)?(b.emailInput().after('<span class="help-inline">'+a.language("COM_KOMENTO_FORM_NOTIFICATION_EMAIL_INVALID")+"</span>"),b.emailInput().parents("li").addClass("error"),i.push("1")):b.emailInput().parents("li").removeClass("error"),b.websiteInput().siblings("span").remove(),e.length==0&&(Komento.options.config.show_website==2&&Komento.options.config.require_website==2||Komento.options.guest==1&&Komento.options.config.show_website>0&&Komento.options.config.require_website==1)?(b.websiteInput().after('<span class="help-inline">'+a.language("COM_KOMENTO_FORM_NOTIFICATION_WEBSITE_REQUIRED")+"</span>"),b.websiteInput().parents("li").addClass("error"),i.push("1")):e.length>0&&!b.validateWebsite(e)?(b.websiteInput().after('<span class="help-inline">'+a.language("COM_KOMENTO_FORM_NOTIFICATION_WEBSITE_INVALID")+"</span>"),b.websiteInput().parents("li").addClass("error"),i.push("1")):b.websiteInput().parents("li").removeClass("error"),Komento.options.config.show_tnc==1&&b.tncCheckbox().prop("checked")==0&&(b.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_TNC_REQUIRED")),i.push("1")),(b.locationLongitude().val()==""||b.locationLatitude().val()==""||b.locationInput().val()=="")&&b.locationInput().val(""),i.length==0?b.kmt.commentupload?b.kmt.commentupload.startUpload():b.postComment():b.parentid==0?b.submitButton().text(a.language("COM_KOMENTO_FORM_SUBMIT")):b.submitButton().text(a.language("COM_KOMENTO_FORM_REPLY"))},experimentalValidateComment:function(){if(Komento.options.konfig.enable_live_form_validation==0)return b.submitButton().enable(),!0;var c=a.trim(b.nameInput().val()),d=a.trim(b.emailInput().val()),e=a.trim(b.websiteInput().val()),f=a.trim(b.commentInput().val()),g=a.trim(b.captchaResponse().val()),h=a.trim(b.recaptchaResponse().val()),i=[];b.commentInput().val().length==0?i.push("1"):Komento.options.config.antispam_min_length_enable==1&&Komento.options.config.antispam_min_length>0&&f.length<Komento.options.config.antispam_min_comment_length&&i.push("1"),(b.captchaResponse().exists()&&g.length==0||b.recaptchaResponse().exists()&&h.length==0)&&i.push("1"),c.length==0&&(Komento.options.config.show_name==2&&Komento.options.config.require_name==2||Komento.options.guest==1&&Komento.options.config.show_name>0&&Komento.options.config.require_name==1)&&i.push("1"),d.length==0&&(Komento.options.config.show_email==2&&(Komento.options.config.require_email==2||b.subscribeCheckbox().prop("checked"))||Komento.options.guest==1&&Komento.options.config.show_email>0&&(Komento.options.config.require_email==1||b.subscribeCheckbox().prop("checked")))&&i.push("1"),e.length==0&&(Komento.options.config.show_website==2&&Komento.options.config.require_website==2||Komento.options.guest==1&&Komento.options.config.show_website>0&&Komento.options.config.require_website==1)&&i.push("1"),Komento.options.config.show_tnc==1&&b.tncCheckbox().prop("checked")==0&&i.push("1"),i.length==0?b.submitButton().enable():b.submitButton().disable()},validateEmail:function(a){if(Komento.options.config.enable_email_regex==1){var b=RegExp(Komento.options.config.email_regex);return b.test(a)}return!0},validateWebsite:function(a){if(Komento.options.config.enable_website_regex==1){var b=RegExp(Komento.options.config.website_regex);return b.test(a)}return!0},postComment:function(){b.submitButton().disable();var c=[];b.kmt.commentupload&&(c=b.kmt.commentupload.options.uploadedId),Komento.ajax("site.views.komento.addcomment",{component:Komento.component,cid:Komento.cid,comment:b.commentInput().val(),parent_id:b.parentid,username:b.usernameInput().val(),name:b.nameInput().val(),email:b.emailInput().val(),website:b.websiteInput().val(),subscribe:b.subscribeCheckbox().prop("checked"),register:b.registerCheckbox().prop("checked"),tnc:b.tncCheckbox().prop("checked"),recaptchaChallenge:b.recaptchaChallenge().val(),recaptchaResponse:b.recaptchaResponse().val(),captchaResponse:b.captchaResponse().val(),captchaId:b.captchaId().val(),latitude:b.locationLatitude().val(),longitude:b.locationLongitude().val(),address:b.locationInput().val(),contentLink:Komento.contentLink,attachments:c},{success:function(c,d,e){var f=a(d),g=f.attr("id");e==1?(Komento.options.acl.read_comment==1&&b.kmt.commentlist.addComment(c,d),b.successNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_SUBMITTED"))):b.successNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_PENDING")),(b.captchaId().length!=0||a("#recaptcha_table").length!=0)&&b.reloadCaptcha(),b.parentid!=0&&b.kmt.commentlist.cancelReply(),b.commentInput().val(""),b.commentLengthCount().text("0"),b.locationForm().length>0&&b.locationForm().controller().removeLocation(),b.parentid==0?b.submitButton().text(a.language("COM_KOMENTO_FORM_SUBMIT")):b.submitButton().text(a.language("COM_KOMENTO_FORM_REPLY")),b.kmt.commentupload&&(b.kmt.commentupload.options.uploadedId=[])},fail:function(c){b.errorNotification(a.language("COM_KOMENTO_ERROR")),b.submitButton().text(a.language("COM_KOMENTO_ERROR"))},captcha:function(c){Komento.options.config.antispam_captcha_type==1?Recaptcha.reload():(b.captchaImage().attr("src",c.image),b.captchaId().val(c.id),b.captchaResponse().val("")),b.parentid==0?b.submitButton().text(a.language("COM_KOMENTO_FORM_SUBMIT")):b.submitButton().text(a.language("COM_KOMENTO_FORM_REPLY"))},subscribe:function(){b.subscribeForm().text(a.language("COM_KOMENTO_FORM_NOTIFICATION_SUBSCRIBED")).addClass("subscribed")},confirmSubscribe:function(){b.subscribeForm().text(a.language("COM_KOMENTO_FORM_NOTIFICATION_SUBSCRIBE_CONFIRMATION_REQUIRED")).addClass("subscribed")},subscribeError:function(){b.subscribeForm().text(a.language("COM_KOMENTO_FORM_NOTIFICATION_SUBSCRIBE_ERROR"))},notification:function(a){b.notification(a)},error:function(c){b.errorNotification(c),b.parentid==0?b.submitButton().text(a.language("COM_KOMENTO_FORM_SUBMIT")):b.submitButton().text(a.language("COM_KOMENTO_FORM_REPLY"))}})},reloadCaptcha:function(){Komento.options.config.antispam_captcha_type==1?Recaptcha.reload():Komento.ajax("site.views.komento.reloadCaptcha",{component:Komento.component},{success:function(a){b.captchaImage().attr("src",a.image),b.captchaId().val(a.id),b.captchaResponse().val("")}})},staticReply:function(c){var d=c.split("-")[1];b.parentid=d;var e=a("#"+c),f=e.find(".kmt-avatar:not(.parentContainer > .kmt-avatar)").clone(),g=e.find(".kmt-author:not(.parentContainer > .kmt-author)").clone(),h=e.find(".kmt-time:not(.parentContainer > .kmt-time)").clone(),i=e.find(".commentText:not(.parentContainer > .commentText)").clone(),j='<a href="javascript:void(0);" class="cancelStaticReply">x</a>'+a.language("COM_KOMENTO_FORM_IN_REPLY_TO")+'<a href="'+Komento.contentLink+"#"+c+'" class="parentLink kmt-parent-link">'+"#"+d+"</a>",k=a('<span class="parentContainer hidden"></span>');k.html("").append(f).append(g).append(h).append(i),b.element.find("h3").html("").append(j).append(k),b.submitButton().text(a.language("COM_KOMENTO_FORM_REPLY")),b.element.scroll()},cancelStaticReply:function(){b.parentid=0,b.element.find("h3").text(a.language("COM_KOMENTO_FORM_LEAVE_YOUR_COMMENTS"))},reply:function(c){b.loadForm(),b.parentid=c.id,b.element.find("h3").text(a.language("COM_KOMENTO_FORM_REPLY")),b.element.find(".submitButton").text(a.language("COM_KOMENTO_FORM_REPLY")),c.mine.append(b.element).scroll()},cancelReply:function(){b.hideForm(),b.element.find("h3").text(a.language("COM_KOMENTO_FORM_LEAVE_YOUR_COMMENTS")),b.parentid=0,b.element.find(".submitButton").text(a.language("COM_KOMENTO_FORM_SUBMIT")),Komento.options.config.form_position==0?Komento.options.config.tabbed_comments==0?a(".commentTools").before(b.element):a(".fameList").before(b.element):Komento.options.config.tabbed_comments==0?a(".commentList").after(b.element):a(".fameList").after(b.element)},unsubscribe:function(){Komento.ajax("site.views.komento.unsubscribe",{component:Komento.component,cid:Komento.cid},{success:function(){b.subscribeForm().text(a.language("COM_KOMENTO_FORM_NOTIFICATION_UNSUBSCRIBED")).removeClass("subscribed")},fail:function(){b.subscribeForm().text(a.language("COM_KOMENTO_ERROR"))}})},errorNotification:function(a){b.formAlert().removeClass("success").addClass("error"),b.notification(a)},successNotification:function(a){b.formAlert().removeClass("error").addClass("success");var c=parseInt(Komento.options.config.autohide_form_notification);b.notification(a,c)},notification:function(a,c){b.formAlert().show(),b.formAlert().append("<li>"+a+"</li>"),c==1&&setTimeout(function(){b.closeNotification()},5e3)},closeNotification:function(){b.formAlert().hide()},clearNotification:function(){b.formAlert().html("").removeClass("error").hide()}}}),b.resolve()})});