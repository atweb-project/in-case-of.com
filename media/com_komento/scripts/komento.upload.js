Komento.module("komento.upload",function(a){var b=this;Komento.require().library("plupload").view("comment/form/uploadheader","comment/form/uploadrow").done(function(){Komento.Controller("UploadForm",{defaults:{uploadUrl:a.indexUrl+"?option=com_komento&controller=file&task=upload",uploadedId:[],"{uploader}":".uploaderForm","{uploadButton}":".uploadButton","{uploadArea}":".uploadArea","{uploadQueue}":".uploadQueue","{queueHeader}":".queueHeader","{queueRow}":".queueRow","{removeFile}":".removeFile","{fileCounter}":".fileCounter",view:{uploadheader:"comment/form/uploadheader",uploadrow:"comment/form/uploadrow"}}},function(b){return{init:function(){b.uploader().implement("plupload",{settings:{url:b.options.uploadUrl,drop_element:"uploadArea",max_file_size:Komento.options.config.upload_max_size+"mb",filters:[{title:"Allowed File Type",extensions:Komento.options.config.upload_allowed_extension}]},"{uploader}":".uploaderForm","{uploadButton}":".uploadButton"},function(){b.plupload=this.plupload,b.plupload.runtime=="html5"&&b.enableDragDrop()})},"{uploader} FilesAdded":function(a,c,d,e){b.addFiles(e)},"{uploader} UploadComplete":function(c,d,e,f){a(".queueRow").each(function(c,d){b.removeRow(a(d).attr("id"))}),b.kmt.form.postComment()},"{uploader} FileUploaded":function(a,c,d,e,f){f.status==1&&b.options.uploadedId.push(f.id)},"{uploader} QueueChanged":function(a,c,d){b.fileCounter().text(d.files.length)},"{uploader} Error":function(c,d,e,f){b.kmt.form.clearNotification();switch(f.code){case-600:b.kmt.form.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_MAX_FILE_SIZE",Komento.options.config.upload_max_size+"mb"));break;case-601:b.kmt.form.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_FILE_EXTENSION",Komento.options.config.upload_allowed_extension))}},"{removeFile} click":function(a){var c=a.parents("tr").attr("id");b.removeRow(c)},enableDragDrop:function(){b.uploadArea().append(a.language("COM_KOMENTO_FORM_OR_DROP_FILES_HERE"))},startUpload:function(){b.plupload.files.length>0?b.plupload.start():b.kmt.form.postComment()},addFiles:function(c){a.each(c,function(c,d){b.kmt.form.clearNotification();if(b.plupload.files.length>Komento.options.config.upload_max_file)return b.plupload.removeFile(d),b.kmt.form.errorNotification(a.language("COM_KOMENTO_FORM_NOTIFICATION_MAX_FILE_ITEM",Komento.options.config.upload_max_file)),!0;if(d.status!=1)return!0;var e=parseInt(d.size/1024),f=b.view.uploadrow({id:d.id,filename:d.name,size:e});f.data("fileitem",d),b.queueRow().length==0&&b.addHeader(),b.uploadQueue().append(f)})},addHeader:function(){var a=b.view.uploadheader({maxcounter:Komento.options.config.upload_max_file});b.uploadQueue().append(a)},removeHeader:function(){b.uploadQueue().find("thead").remove(),b.uploadQueue().find("tbody").remove()},removeRow:function(c){a("#"+c).remove(),b.queueRow().length==0&&b.removeHeader();var d=b.plupload.getFile(c);b.plupload.removeFile(d)}}}),b.resolve()})});