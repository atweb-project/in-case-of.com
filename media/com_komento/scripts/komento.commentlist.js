Komento.module("komento.commentlist",function(a){var b=this;Komento.require().library("effects/highlight","effects/fade").image(Komento.options.spinner).script("sharelinks","markitup","komento.common","komento.commentitem","komento.bbcode").done(function(){Komento.Controller("CommentList",{defaults:{"{commentList}":".kmt-list","{commentItem}":".kmt-item","{noComment}":".kmt-empty-comment","{loadMore}":".loadMore","{commentText}":".commentText","{commentInfo}":".commentInfo","{commentForm}":".commentForm","{deleteButton}":".deleteButton","{editButton}":".editButton","{saveEditButton}":".saveEditButton","{cancelEditButton}":".cancelEditButton","{editForm}":".editForm","{editInput}":".editInput","{replyButton}":".replyButton","{shareBox}":".shareBox","{reportButton}":".reportButton","{statusButton}":".statusButton","{statusOptions}":".statusOptions","{publishButton}":".publishButton","{unpublishButton}":".unpublishButton","{stickButton}":".stickButton","{likeButton}":".likeButton","{likesCounter}":".likesCounter","{parentLink}":".parentLink","{parentContainer}":".parentContainer","{socialButton}":".socialButton","{attachmentWrap}":".attachmentWrap","{attachmentList}":".attachmentList","{attachmentFile}":".attachmentFile","{attachmentDelete}":".attachmentDelete",view:{editForm:"comment/item/edit.form",deleteSingle:"dialogs/delete.single",deleteChilds:"dialogs/delete.affectchild",publishDialog:"dialogs/publish.affectchild",unpublishDialog:"dialogs/unpublish.affectchild",deleteAttachment:"dialogs/delete.attachment"}}},function(b){return{init:function(){if(b.noComment().length==0){b.generateSharelinks();if(Komento.options.konfig.enable_ajax_permalink==1){var a=document.location.href.split("#"),c;for(var d=0;d<a.length;d++)if(a[d].substring(0,4)=="kmt-"){c=a[d];break}c&&b.finditem(c)}}},generateSharelinks:function(){var c=function(){b.socialButton().each(function(b,c){a(c).sharelinks()})};b.generateShortLinks(c)},generateShortLinks:function(c){var d=function(d){b.socialButton().each(function(b,c){if(!a(c).attr("loaded")){var e=a(c).attr("commentid"),f=d+"#kmt"+e;a(c).attr("url",f),a(c).parents(".kmt-share-balloon").find(".short-url").val(f)}}),c&&c()};Komento.shortenLink?d(Komento.shortenLink):a.shortenlink(Komento.contentLink,d)},finditem:function(c){a("#"+c).length==0?!b.loadMore().is(":hidden")&&b.loadMore().length!=0&&b.loadMoreComments(function(){b.finditem(c)}):(a("#"+c).scroll(),a("#"+c).highlight())},"{loadMore} click":function(a){a.checkClick()&&(a.loading(),b.loadMoreComments())},addComment:function(c,d,e){var f=a(d),g=f.attr("id"),h=0;if(b.noComment().length!=0)b.noComment().remove(),b.commentList().append(f),h=1;else if(Komento.options.config.enable_threaded==1)if(c==0){if(Komento.options.config.load_previous==1||b.loadMore().length==0||b.loadMore().is(":hidden"))b.commentList().append(f),h=1}else b.commentList().find("#kmt-"+c).next().attr("id")=="kmt-form"?(b.commentList().find("#kmt-"+c).next().after(f),h=1):(b.commentList().find("#kmt-"+c).after(f),h=1);else Komento.options.config.load_previous==1?(Komento.sort=="oldest"&&(b.commentList().append(f),h=1),Komento.sort=="latest"&&(b.loadMore().length==0||b.loadMore().is(":hidden"))&&(b.commentList().prepend(f),h=1)):(Komento.sort=="oldest"&&(b.loadMore().length==0||b.loadMore().is(":hidden"))&&(b.commentList().append(f),h=1),Komento.sort=="latest"&&(b.commentList().prepend(f),h=1));h&&(Komento.loadedCount++,c!=0&&b.addChildCount(a("#"+g).attr("parentid")),b.generateSharelinks(),Komento.options.config.scroll_to_comment==1&&a("#"+g).highlight().scroll()),b.kmt.tools.addCommentCounter(),Komento.totalCount++},addChildCount:function(c){var d=parseInt(a("."+c).attr("childs"));a("."+c).attr("childs",d+1),a("."+c).exists()&&parseInt(a("."+c).attr("parentid").split("-")[1])>0&&b.addChildCount(a("."+c).attr("parentid"))},loadMoreComments:function(c){var d,e=parseInt(Komento.options.config.max_comments_per_page);Komento.options.config.load_previous==1?(d=Komento.totalCount-Komento.loadedCount-e,d<0&&(e+=d,d=0)):d=Komento.loadedCount,Komento.ajax("site.views.komento.loadmorecomments",{component:Komento.component,cid:Komento.cid,start:d,limit:e,sort:Komento.sort,contentLink:Komento.contentLink},{success:function(d,f,g){var h=a(d).filter("li");Komento.options.config.load_previous==1?b.commentList().prepend(h):b.commentList().append(h),h.highlight(),Komento.loadedCount=f,b.loadMore().removeClass("loading");if(g==1){b.loadMore().removeClass("disabled");var i;Komento.options.config.load_previous==1?(i=Komento.totalCount-Komento.loadedCount-e,i<0&&(e+=i,i=0)):i=Komento.loadedCount,b.loadMore().attr("href","#!kmt-start="+i)}else b.loadMore().hide();c&&c()},fail:function(a,b,c){}})},set:function(a){b.item=a.itemset(b.options)},"{deleteButton} click":function(a,c){c.stopPropagation(),b.set(a),b.showDeleteDialog()},"{editButton} click":function(a,c){c.stopPropagation(),b.set(a),a.checkClick()&&(a.loading(),a.checkSwitch()?b.edit(a):b.cancelEdit(a))},"{saveEditButton} click":function(a,c){c.stopPropagation(),b.set(a),b.saveEdit(a)},"{cancelEditButton} click":function(a,c){c.stopPropagation(),b.set(a),b.cancelEdit(a)},"{replyButton} click":function(a,c){c.stopPropagation(),b.set(a),Komento.options.konfig.enable_inline_reply==1?a.checkSwitch()?b.reply(a):b.cancelReply(a):b.kmt.form.staticReply(b.item.parentid)},"{reportButton} click":function(a,c){c.stopPropagation(),b.set(a),a.checkClick()&&(a.loading(),a.checkSwitch()?b.reportComment(a):b.cancelreportComment(a))},"{publishButton} click":function(a,c){c.stopPropagation(),b.set(a),b.item.childs>0?b.showPublishDialog(a):b.publishComment(a)},"{unpublishButton} click":function(a,c){c.stopPropagation(),b.set(a),b.item.childs>0?b.showUnpublishDialog(a):b.unpublishComment(a)},"{stickButton} click":function(a,c){c.stopPropagation(),b.set(a),a.checkClick()&&(a.loading(),a.checkSwitch()?b.stick(a):b.unstick(a))},"{likesCounter} click":function(a,c){c.stopPropagation(),b.set(a),b.showLikesDialog(a)},"{likeButton} click":function(a,c){c.stopPropagation(),b.set(a),a.checkClick()&&(a.find("span").loading(),a.checkSwitch()?b.like(a):b.unlike(a))},"{parentLink} mouseover":function(c){b.set(c),Komento.options.config.enable_threaded==1?a("#"+b.item.parentid).addClass("kmt-highlight"):(b.item.element.mine.parentContainer.show(),b.item.element.mine.parentContainer.attr("loaded")==0&&(b.item.element.mine.parentContainer.html('<img src="'+Komento.options.spinner+'" />'),b.loadParent()))},"{parentLink} mouseout":function(c){b.set(c),Komento.options.config.enable_threaded==1?a("#"+b.item.parentid).removeClass("kmt-highlight"):b.item.element.mine.parentContainer.hide()},"{parentLink} click":function(c){b.set(c);var d=a("."+b.item.parentid);d.highlight()},"{attachmentDelete} click":function(a,c){c.stopPropagation(),b.set(a),b.showAttachmentDeleteDialog(a)},closeDialog:function(){a(".foundryDialog").length>0&&a(".foundryDialog").controller().close()},edit:function(){var c=b.item.mine.find("#"+b.item.commentid+"-edit");c.length==0?Komento.ajax("site.views.komento.getcommentraw",{id:b.item.id},{success:function(c){b.item.element.mine.editButton.text(a.language("COM_KOMENTO_COMMENT_EDIT_CANCEL")).switchOff().doneLoading().enable();var d=b.view.editForm({commentId:b.item.commentid,commentText:c});b.item.element.mine.commentText.after(d),b.item.element.mine.editForm=a(d),b.item.element.mine.editInput=b.item.element.mine.editForm.find(".editInput"),b.item.mine.data("item",b.item),b.item.element.mine.editInput.markItUp(a.getBBcodeSettings())},fail:function(){b.item.element.mine.editButton.text(a.language("COM_KOMENTO_ERROR")).doneLoading()}}):(c.show(),b.item.element.mine.editButton.text(a.language("COM_KOMENTO_COMMENT_EDIT_CANCEL")).switchOff().doneLoading().enable())},cancelEdit:function(){b.item.element.mine.editButton.text(a.language("COM_KOMENTO_COMMENT_EDIT")).switchOn().doneLoading().enable(),b.item.element.mine.editForm.hide()},saveEdit:function(){Komento.ajax("site.views.komento.editcomment",{id:b.item.id,edittedComment:b.item.element.mine.editInput.val()},{success:function(c,d,e){b.item.element.both.commentText.html(c),Komento.options.config.enable_info==1&&b.item.element.both.commentInfo.text(a.language("COM_KOMENTO_COMMENT_EDITTED_BY",d,e)).show().css("display",""),b.cancelEdit()},fail:function(a){}})},reply:function(){a(".formAlert").hide().text(""),a(b.options["{replyButton}"]).switchOn().find("span").text(a.language("COM_KOMENTO_COMMENT_REPLY")),b.item.element.mine.replyButton.switchOff().find("span").text(a.language("COM_KOMENTO_COMMENT_REPLY_CANCEL")),b.kmt.form.reply(b.item)},cancelReply:function(){a(b.options["{replyButton}"]).switchOn().find("span").text(a.language("COM_KOMENTO_COMMENT_REPLY")),b.kmt.form.cancelReply()},showDeleteDialog:function(){b.item.childs>0?a.dialog({content:b.view.deleteChilds(!0,{childs:b.item.childs}),afterShow:function(){a(".foundryDialog").find(".delete-affectChild").click(function(){b.deleteComment(1)}),a(".foundryDialog").find(".delete-moveChild").click(function(){b.deleteComment(0)})}}):a.dialog({content:b.view.deleteSingle(!0),afterShow:function(){a(".foundryDialog").find(".delete-affectChild").click(function(){b.deleteComment(1)})}})},deleteComment:function(c){a(".foundryDialog").find(".kmt-delete-status").show(),Komento.ajax("site.views.komento.deletecomment",{id:b.item.id,affectChild:c},{success:function(){b.closeDialog(),c==1?b.deleteChild(b.item.commentid):b.moveChildUp(b.item.commentid,b.item.parentid),b.item.both.hide("fade",function(){b.item.both.remove()}),Komento.loadedCount-=1,Komento.totalCount-=1},fail:function(){a(".foundryDialog").find(".kmt-delete-status").text(a.language("COM_KOMENTO_ERROR"))}})},deleteChild:function(c){a('li[parentid="'+c+'"]').each(function(){b.deleteChild(a(this).attr("id"))}).hide("fade",function(){a(this).remove()});var d=a('li[parentid="'+c+'"]').length;Komento.loadedCount-=d,Komento.totalCount-=d},moveChildUp:function(c,d){a('li[parentid="'+c+'"]').attr("parentid",d).each(function(){a(this).removeClass("kmt-child-"+a(this).attr("depth")).addClass("kmt-child-"+(a(this).attr("depth")-1)),a(this).attr("depth",a(this).attr("depth")-1),b.moveChildUp(a(this).attr("id"))})},reportComment:function(){Komento.ajax("site.views.komento.action",{id:b.item.id,type:"report",action:"add"},{success:function(){b.item.element.both.reportButton.text(a.language("COM_KOMENTO_COMMENT_REPORTED")).switchOff().doneLoading().enable()},fail:function(){b.item.element.both.reportButton.text(a.language("COM_KOMENTO_ERROR"))}})},cancelreportComment:function(){Komento.ajax("site.views.komento.action",{id:b.item.id,type:"report",action:"remove"},{success:function(){b.item.element.both.reportButton.text(a.language("COM_KOMENTO_COMMENT_REPORT")).switchOn().doneLoading().enable()},fail:function(){b.item.element.both.reportButton.text(a.language("COM_KOMENTO_ERROR"))}})},showUnpublishDialog:function(){a.dialog({content:b.view.unpublishDialog(!0,{childs:b.item.childs}),afterShow:function(){a(".foundryDialog").find(".unpublish-affectChild").click(function(){b.unpublishComment()})}})},unpublishComment:function(){Komento.ajax("site.views.komento.unpublish",{id:b.item.id},{success:function(){b.closeDialog(),b.unpublishChild(b.item.commentid),b.item.both.hide("fade",function(){b.item.both.remove()}),Komento.loadedCount-=1,Komento.totalCount-=1},fail:function(){}})},unpublishChild:function(c){a('li[parentid="'+c+'"]').each(function(){b.unpublishChild(a(this).attr("id"))}).hide("fade",function(){a(this).remove()});var d=a('li[parentid="'+c+'"]').length;Komento.loadedCount-=d,Komento.totalCount-=d},showPublishDialog:function(){},publishComment:function(){},publishChild:function(a){},stick:function(c){Komento.ajax("site.views.komento.stick",{id:b.item.id},{success:function(){b.item.element.mine.stickButton.text(a.language("COM_KOMENTO_COMMENT_UNSTICK")).switchOff().doneLoading().enable(),b.item.mine.addClass("kmt-sticked"),b.kmt.famelist.stickComment(b.item.mine.clone())},fail:function(){b.item.element.mine.stickButton.text(a.language("COM_KOMENTO_ERROR"))}})},unstick:function(){Komento.ajax("site.views.komento.unstick",{id:b.item.id},{success:function(){b.item.element.both.stickButton.text(a.language("COM_KOMENTO_COMMENT_STICK")).switchOn().doneLoading().enable(),b.item.both.removeClass("kmt-sticked"),b.kmt.famelist.unstickComment(b.item.commentid)},fail:function(){b.stickButton.text(a.language("COM_KOMENTO_ERROR"))}})},like:function(){Komento.ajax("site.views.komento.action",{id:b.item.id,type:"likes",action:"add"},{success:function(){b.item.element.both.likeButton.switchOff().enable().find("span").doneLoading().text(a.language("COM_KOMENTO_COMMENT_UNLIKE"));var c=parseInt(b.item.element.mine.likesCounter.find("span").text())+1;b.item.element.both.likesCounter.find("span").text(c)},fail:function(a){b.item.element.both.likesCounter.find("span").doneLoading().text(a)}})},unlike:function(){Komento.ajax("site.views.komento.action",{id:b.item.id,type:"likes",action:"remove"},{success:function(){b.item.element.both.likeButton.switchOn().enable().find("span").doneLoading().text(a.language("COM_KOMENTO_COMMENT_LIKE"));var c=parseInt(b.item.element.mine.likesCounter.find("span").text())-1;b.item.element.both.likesCounter.find("span").text(c)},fail:function(){b.item.element.both.likesCounter.find("span").doneLoading().text(a.language("COM_KOMENTO_ERROR"))}})},showLikesDialog:function(c){Komento.ajax("site.views.komento.getLikedUsers",{id:b.item.id},{success:function(b){a.dialog({title:a.language("COM_KOMENTO_COMMENT_PEOPLE_WHO_LIKED_THIS"),content:b})}})},loadParent:function(){var c=a("#"+b.item.parentid);if(c.length!=0){var d=c.find(".kmt-avatar:not(.parentContainer > .kmt-avatar)").clone(),e=c.find(".kmt-author:not(.parentContainer > .kmt-author)").clone(),f=c.find(".kmt-time:not(.parentContainer > .kmt-time)").clone(),g=c.find(".commentText:not(.parentContainer > .commentText)").clone();b.item.element.both.parentContainer.html("").append(d).append(e).append(f).append(g)}else{var h=b.item.parentid.split("-")[1];Komento.ajax("site.views.komento.getcomment",{id:h},{success:function(a){b.item.element.both.parentContainer.html(a)},fail:function(){}})}b.item.element.both.parentContainer.attr("loaded",1)},showAttachmentDeleteDialog:function(c){var d=a(c).parents(".attachmentFile").attr("attachmentid"),e=a(c).parents(".attachmentFile").attr("attachmentname");a.dialog({content:b.view.deleteAttachment(!0,{attachmentname:e}),afterShow:function(){a(".foundryDialog").find(".delete-attachment").click(function(){b.closeDialog(),b.deleteFile(d)}),a(".foundryDialog").find(".delete-attachment-cancel").click(function(){b.closeDialog()})}})},deleteFile:function(a){var c=b.item.id;Komento.ajax("site.views.komento.deleteAttachment",{id:c,attachmentid:a},{success:function(){b.item.element.both.attachmentFile.filter(".file-"+a).remove(),b.item.mine.find(".attachmentFile").length==0&&b.item.element.both.attachmentWrap.remove()},fail:function(a){alert("error deleting attachment at "+a)}})}}}),b.resolve()})});