Komento.module("location",function(a){var b=this;Komento.require().library("throttle-debounce","ui/autocomplete").done(function(){Komento.Controller("Location.Form",{defaultOptions:{language:"en",initialLocation:null,"{locationInput}":".locationInput","{locationLatitude}":".locationLatitude","{locationLongitude}":".locationLongitude","{locationMap}":".locationMap","{autoDetectButton}":".autoDetectButton"}},function(b){return{init:function(){var c=a.Deferred(),d=a.uid("ext");window[d]=function(){c.resolve()},Komento.require().script({prefetch:!1},"https://maps.googleapis.com/maps/api/js?sensor=true&language="+b.options.language+"&callback="+d).done(function(){c.done(b._init)})},_init:function(){b.geocoder=new google.maps.Geocoder,b.hasGeolocation=navigator.geolocation!==undefined,b.hasGeolocation?b.autoDetectButton().show():b.autoDetectButton().remove(),b.locationInput().focus().autocomplete({delay:300,minLength:0,source:b.retrieveSuggestions,select:function(a,c){b.locationInput().autocomplete("close"),b.setLocation(c.item.location)}}).prop("disabled",!1),b.autocomplete=b.locationInput().autocomplete("widget"),b.autocomplete.addClass("location-suggestion");var c=a.trim(b.options.initialLocation);c&&b.getLocationByAddress(c,function(a){b.setLocation(a[0])}),b.busy(!1)},busy:function(a){b.locationInput().toggleClass("loading",a)},getUserLocations:function(a){b.getLocationAutomatically(function(c){b.userLocations=b.buildDataset(c),a&&a(c)})},getLocationByAddress:function(a,c){b.geocoder.geocode({address:a},c)},getLocationByCoords:function(a,c,d){b.geocoder.geocode({location:new google.maps.LatLng(a,c)},d)},getLocationAutomatically:function(a,c){if(!navigator.geolocation)return c("ERRCODE","Browser does not support geolocation or do not have permission to retrieve location data.");navigator.geolocation.getCurrentPosition(function(c){b.getLocationByCoords(c.coords.latitude,c.coords.longitude,a)},c)},renderMap:function(a,c){b.busy(!0),b.locationMap().show();var d=new google.maps.Map(b.locationMap()[0],{zoom:15,center:a.geometry.location,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0}),e=new google.maps.Marker({position:a.geometry.location,center:a.geometry.location,title:a.formatted_address,map:d}),f=new google.maps.InfoWindow({content:c});google.maps.event.addListener(d,"tilesloaded",function(){f.open(d,e),b.busy(!1)})},setLocation:function(a){if(!a)return;b.locationResolved=!0,b.lastResolvedLocation=a,b.locationInput().val(a.formatted_address),b.locationLatitude().val(a.geometry.location.lat()),b.locationLongitude().val(a.geometry.location.lng()),b.renderMap(a,a.formatted_address)},removeLocation:function(){b.locationResolved=!1,b.locationInput().val(""),b.locationLatitude().val(""),b.locationLongitude().val(""),b.locationMap().hide()},buildDataset:function(b){var c=a.map(b,function(a){return{label:a.formatted_address,value:a.formatted_address,location:a}});return c},retrieveSuggestions:function(a,c){b.busy(!0);var d=a.term,e=function(a){c(a),b.busy(!1)};d==""?e(b.userLocations||[]):b.getLocationByAddress(d,function(a){e(b.buildDataset(a))})},suggestUserLocations:function(){b.hasGeolocation&&b.userLocations&&(b.removeLocation(),b.locationInput().autocomplete("search","")),b.busy(!1)},"{locationInput} blur":function(){setTimeout(function(){var c=a.trim(b.locationInput().val());c==""?b.removeLocation():b.locationResolved?c!=b.lastResolvedLocation.formatted_address&&b.setLocation(b.lastResolvedLocation):b.removeLocation()},250)},"{autoDetectButton} click":function(){b.busy(!0),b.hasGeolocation&&!b.userLocations?b.getUserLocations(b.suggestUserLocations):b.suggestUserLocations()}}}),Komento.Controller("Location.Form.Simple",{defaultOptions:{language:"en",initialLocation:null,"{locationInput}":".locationInput","{locationLatitude}":".locationLatitude","{locationLongitude}":".locationLongitude","{autoDetectButton}":".autoDetectButton"}},function(b){return{init:function(){b.locationInput().val(a.language("COM_KOMENTO_COMMENT_WHERE_ARE_YOU")),b.locationLongitude().val(""),b.locationLatitude().val(""),b.locationInput().one("focus",function(){b.locationInput().val("")});var c=a.uid("ext");window[c]=function(){a.___GoogleMaps.resolve()},a.___GoogleMaps||(a.___GoogleMaps=a.Deferred(),Komento.require().script({prefetch:!1},"https://maps.googleapis.com/maps/api/js?sensor=true&language="+b.options.language+"&callback="+c)),a.___GoogleMaps.done(function(){b._init()})},_init:function(){b.geocoder=new google.maps.Geocoder,b.hasGeolocation=navigator.geolocation!==undefined,b.hasGeolocation?b.autoDetectButton().show():b.autoDetectButton().remove(),b.locationInput().autocomplete({delay:300,minLength:0,source:b.retrieveSuggestions,select:function(a,c){b.locationInput().autocomplete("close"),b.setLocation(c.item.location)}}).prop("disabled",!1),b.autocomplete=b.locationInput().autocomplete("widget"),b.autocomplete.addClass("location-suggestion");var c=a.trim(b.options.initialLocation);c&&b.getLocationByAddress(c,function(a){b.setLocation(a[0])}),b.busy(!1)},busy:function(a){b.locationInput().toggleClass("loading",a)},getUserLocations:function(a){b.getLocationAutomatically(function(c){b.userLocations=b.buildDataset(c),a&&a(c)})},getLocationByAddress:function(a,c){b.geocoder.geocode({address:a},c)},getLocationByCoords:function(a,c,d){b.geocoder.geocode({location:new google.maps.LatLng(a,c)},d)},getLocationAutomatically:function(a,c){if(!navigator.geolocation)return c("ERRCODE","Browser does not support geolocation or do not have permission to retrieve location data.");navigator.geolocation.getCurrentPosition(function(c){b.getLocationByCoords(c.coords.latitude,c.coords.longitude,a)},c)},setLocation:function(a){if(!a)return;b.locationResolved=!0,b.lastResolvedLocation=a,b.locationInput().val(a.formatted_address),b.locationLatitude().val(a.geometry.location.lat()),b.locationLongitude().val(a.geometry.location.lng())},removeLocation:function(){b.locationResolved=!1,b.locationInput().val(""),b.locationLatitude().val(""),b.locationLongitude().val("")},buildDataset:function(b){var c=a.map(b,function(a){return{label:a.formatted_address,value:a.formatted_address,location:a}});return c},retrieveSuggestions:function(a,c){b.busy(!0);var d=a.term,e=function(a){c(a),b.busy(!1)};d==""?e(b.userLocations||[]):b.getLocationByAddress(d,function(a){e(b.buildDataset(a))})},suggestUserLocations:function(){b.hasGeolocation&&b.userLocations&&(b.removeLocation(),b.locationInput().autocomplete("search","")),b.busy(!1)},"{locationInput} blur":function(){setTimeout(function(){var c=a.trim(b.locationInput().val());c==""?b.removeLocation():b.locationResolved?c!=b.lastResolvedLocation.formatted_address&&b.setLocation(b.lastResolvedLocation):b.removeLocation()},250)},"{autoDetectButton} click":function(){b.busy(!0),b.hasGeolocation&&!b.userLocations?b.getUserLocations(b.suggestUserLocations):b.suggestUserLocations()},"{locationInput} keypress":function(a){a.keypress(function(a){if(a.which==13)return!1})}}}),Komento.Controller("Location.Map",{defaultOptions:{animation:"drop",language:"en",useStaticMap:!1,disableMapsUI:!0,zoom:10,fitBounds:null,center:null,locations:[],width:500,height:400,"{locationMap}":".locationMap"}},function(b){return{init:function(){b.mapLoaded=!1;var c=a.Deferred(),d=a.uid("ext");window[d]=function(){c.resolve()};if(b.options.useStaticMap==1){var e="&language="+(b.options.language+""),f="&size="+(b.options.width+"")+"x"+(b.options.height+""),g="&zoom="+(b.options.zoom+""),h="&center="+(parseFloat(b.options.locations[0].latitude).toFixed(6)+"")+","+(parseFloat(b.options.locations[0].longitude).toFixed(6)+""),i="&markers=",j="https://maps.googleapis.com/maps/api/staticmap?sensor=false"+e+f;if(b.options.locations.length==1)i+=parseFloat(b.options.locations[0].latitude).toFixed(6)+""+","+(parseFloat(b.options.locations[0].longitude).toFixed(6)+""),j+=g+h+i;else{var k=[];a.each(b.options.locations,function(a,b){k.push(parseFloat(b.latitude).toFixed(6)+""+","+(parseFloat(b.longitude).toFixed(6)+""))}),i+=k.join("|"),j+=i}b.locationMap().show().html('<img src="'+j+'" />'),b.busy(!1)}else Komento.require().script({prefetch:!1},"https://maps.googleapis.com/maps/api/js?sensor=true&language="+b.options.language+"&callback="+d).done(function(){c.done(b._init)})},_init:function(){b.options.fitBounds===null&&(b.options.locations.length==1?b.options.fitBounds=!1:b.options.fitBounds=!0),b.options.disableMapsUI=Boolean(b.options.disableMapsUI),b.locations=[],a.each(b.options.locations,function(a,c){b.locations.push(new google.maps.LatLng(c.latitude,c.longitude))}),b.locations.length>0&&b.renderMap(),b.busy(!1)},busy:function(a){b.locationMap().toggleClass("loading",a)},renderMap:function(){b.busy(!0),b.locationMap().show();var a;b.options.center?a=new google.maps.LatLng(center.latitude,center.longitude):a=b.locations[0],b.map=new google.maps.Map(b.locationMap()[0],{zoom:b.options.zoom,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:b.options.disableMapsUI}),google.maps.event.addListener(b.map,"tilesloaded",function(){b.mapLoaded==0&&(b.mapLoaded=!0,b.loadLocations())})},loadLocations:function(){b.bounds=new google.maps.LatLngBounds,b.infoWindow=[];var c=function(){a.each(b.locations,function(a,c){b.bounds.extend(c);var d=function(){b.addMarker(c,b.options.locations[a])};setTimeout(d,100*(a+1))}),b.options.fitBounds&&b.map.fitBounds(b.bounds)};setTimeout(c,500)},addMarker:function(a,c){if(!a)return;var d=new google.maps.Marker({position:a,map:b.map});d.setAnimation(google.maps.Animation.DROP),b.addInfoWindow(d,c)},addInfoWindow:function(c,d){var e=d.content;e||(e=d.address);var f=new google.maps.InfoWindow;f.setContent(e),b.infoWindow.push(f),b.options.locations.length>1?google.maps.event.addListener(c,"click",function(){a.each(b.infoWindow,function(a,b){b.close()}),f.open(b.map,c)}):(google.maps.event.addListener(c,"click",function(){f.open(b.map,c)}),f.open(b.map,c)),google.maps.event.addListener(f,"domready",function(){eblog.ratings.setup("ebpostmap_"+d.id+"-ratings",!0,"entry"),a("#ebpostmap_"+d.id+"-ratings").removeClass("ui-state-disabled"),a("#ebpostmap_"+d.id+"-ratings-form").find(".blog-rating-text").hide()})}}}),b.resolve()})});