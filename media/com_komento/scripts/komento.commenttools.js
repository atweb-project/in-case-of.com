Komento.module("komento.commenttools",function(a){var b=this;Komento.require().script("komento.commentlist","komento.common").done(function(){Komento.Controller("CommentTools",{defaults:{"{commentCounter}":".commentCounter","{sortOldest}":".sortOldest a","{sortLatest}":".sortLatest a","{sortButton}":".kmt-sorting a","{adminButton}":".adminMode a",view:{newComment:"notifications/new.comment"}}},function(b){return{init:function(){Komento.options.acl.read_comment==1&&Komento.options.konfig.enable_ajax_load_list==1&&b.loadCommentList(),Komento.options.konfig.enable_live_notification==1&&(b.hasNew=0,b.newCount=0,b.checkNewComment())},loadCommentList:function(){b.reloadComments("default")},"{sortOldest} click":function(a){b.sortButton().checkClick()&&(b.sortButton().removeClass("selected"),a.loading().addClass("selected"),b.reloadComments("oldest"))},"{sortLatest} click":function(a){b.sortButton().checkClick()&&(b.sortButton().removeClass("selected"),a.loading().addClass("selected"),b.reloadComments("latest"))},"{sortLikes} click":function(a){b.sortButton().checkClick()&&(b.sortButton().removeClass("selected"),a.loading().addClass("selected"),b.reloadComments("likes"))},"{adminButton} click":function(a){b.reloadComments("default","all")},reloadComments:function(c,d){a(".commentList").html('<img src="'+Komento.options.spinner+'" />'+a.language("COM_KOMENTO_COMMENTS_LOADING")),Komento.ajax("site.views.komento.reloadcomments",{component:Komento.component,cid:Komento.cid,contentLink:Komento.contentLink,options:{sort:c,published:d}},{success:function(d,e,f){Komento.sort=c,Komento.loadedCount=e,Komento.totalCount=f;var g=a(d);a(".commentList").html(g).controller().init(),b.sortButton().enable().doneLoading(),a(".kmt-notification").remove()},fail:function(){a(".commentList").text(a.language("COM_KOMENTO_ERROR"))}})},checkNewComment:function(){var c=Komento.options.konfig.live_notification_interval?parseInt(Komento.options.konfig.live_notification_interval)*1e3:3e4;setTimeout(function(){Komento.ajax("site.views.komento.checknewcomment",{component:Komento.component,cid:Komento.cid,total:Komento.totalCount},{success:function(c,d){if(c==1&&d>b.newCount){a(".kmt-notification").remove();var e=b.view.newComment({count:d});e.find(".reloadComments").bind("click",function(){b.kmt.tools.reloadComments(Komento.sort)}),a("body").append(e)}b.newCount=d,b.hasNew=c},fail:function(){},complete:function(){b.kmt.tools.checkNewComment()}})},c)},addCommentCounter:function(){var a=b.commentCounter().find("span").text();b.commentCounter().find("span").text(parseInt(a)+1)},deductCommentCounter:function(){var a=b.commentCounter().text();b.commentCounter().text(parseInt(a)-1)}}}),b.resolve()})});